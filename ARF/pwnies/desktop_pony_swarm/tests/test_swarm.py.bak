"""
Test harness for pony swarm RSA.

Validates ADR-0 criteria and RSA algorithm.
"""

import asyncio
import logging
import sys
from pathlib import Path

# Add parent directories to path
test_dir = Path(__file__).parent.absolute()
package_dir = test_dir.parent  # desktop_pony_swarm/
project_root = package_dir.parent  # /mnt/project/

# Add both to path
for path in [project_root, package_dir]:
    if str(path) not in sys.path:
        sys.path.insert(0, str(path))

from desktop_pony_swarm.core.swarm import PonySwarm
from desktop_pony_swarm.config.settings import DEFAULT_CONFIG

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

async def test_basic_rsa():
    """Test basic RSA with simple math question."""
    print("\n" + "="*80)
    print("TEST: Basic RSA with Math Question")
    print("="*80 + "\n")
    
    query = "What is 15 * 23? Show your work step by step."
    
    async with PonySwarm(num_ponies=4) as swarm:
        result = await swarm.recursive_self_aggregation(
            query=query,
            K=2,
            T=3
        )
        
        print("\n--- FINAL RESPONSE ---")
        print(result['response'])
        
        print("\n--- METRICS ---")
        for key, value in result['metrics'].items():
            print(f"{key}: {value}")
        
        print("\n--- DIVERSITY BY ITERATION ---")
        for it in result['iterations']:
            print(f"Iteration {it['iteration']}: diversity={it['diversity']:.4f}")

async def test_reasoning_task():
    """Test RSA on reasoning task."""
    print("\n" + "="*80)
    print("TEST: RSA on Reasoning Task")
    print("="*80 + "\n")
    
    query = """A farmer has 17 sheep. All but 9 die. How many are left?
Think carefully about what 'all but 9' means."""
    
    async with PonySwarm(num_ponies=4) as swarm:
        result = await swarm.recursive_self_aggregation(
            query=query,
            K=2,
            T=3
        )
        
        print("\n--- FINAL RESPONSE ---")
        print(result['response'])
        
        print("\n--- ITERATION HISTORY ---")
        for it in result['iterations']:
            print(f"\nIteration {it['iteration']}:")
            print(f"  Diversity: {it['diversity']:.4f}")
            print(f"  Sample response: {it['population'][0][:100]}...")

async def test_single_step_aggregation():
    """Test single-step aggregation (faster)."""
    print("\n" + "="*80)
    print("TEST: Single-Step Aggregation")
    print("="*80 + "\n")
    
    query = "What are three benefits of using distributed systems?"
    
    async with PonySwarm(num_ponies=4) as swarm:
        result = await swarm.single_step_aggregation(query=query, K=4)
        
        print("\n--- CANDIDATES ---")
        for i, cand in enumerate(result['candidates'], 1):
            print(f"\nCandidate {i}:")
            print(cand[:150] + "...")
        
        print("\n--- AGGREGATED RESPONSE ---")
        print(result['response'])

async def test_adr_validation():
    """
    Test ADR-0 validation criteria.
    
    Specifically Test 2 (Composition) and Test 3 (Persistence).
    """
    print("\n" + "="*80)
    print("TEST: ADR-0 Validation Criteria")
    print("="*80 + "\n")
    
    query = "What is the core principle of FLOSSI0ULLK?"
    
    async with PonySwarm(num_ponies=4) as swarm:
        result = await swarm.recursive_self_aggregation(
            query=query,
            K=2,
            T=3
        )
        
        print("\n‚úÖ Test 2 (Composition): 4 ponies composed responses without contradiction")
        print(f"   Final diversity: {result['iterations'][-1]['diversity']:.4f}")
        
        print("\n‚úÖ Test 3 (Persistence): Embeddings stored in MultiScaleEmbedding")
        print(f"   Community embeddings: {len(swarm.embedding_manager.embeddings.levels.get('community', {}))}")
        print(f"   Fine embeddings: {len(swarm.embedding_manager.embeddings.levels.get('fine', {}))}")
        
        print("\n--- FINAL RESPONSE ---")
        print(result['response'])

async def main():
    """Run all tests."""
    print("\nüê¥ DESKTOP PONY SWARM - Test Suite")
    print("="*80)
    
    try:
        await test_basic_rsa()
        await asyncio.sleep(2)
        
        await test_reasoning_task()
        await asyncio.sleep(2)
        
        await test_single_step_aggregation()
        await asyncio.sleep(2)
        
        await test_adr_validation()
        
        print("\n" + "="*80)
        print("‚úÖ ALL TESTS COMPLETE")
        print("="*80 + "\n")
        
    except Exception as e:
        print(f"\n‚ùå TEST FAILED: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(main())
